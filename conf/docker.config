/*
========================================================================================
    Docker configuration for pipeline
========================================================================================
    SCOPE: This configuration ONLY applies when using `-profile docker`
          Other profiles (slurm, conda) use their own configurations
    
    Configuration for Docker container execution
    - For macOS ARM64: Uses x86_64 emulation via --platform linux/amd64
    - Wave automatically builds Docker containers from conda specifications
    - Memory requirements are reduced for local Mac execution (16GB constraint)
    - SLURM/HPC users should use `-profile slurm` for full resource allocation
----------------------------------------------------------------------------------------
*/

docker {
    enabled         = true
    runOptions      = '--platform=linux/amd64'
}

wave {
    enabled         = true
    strategy        = 'conda,container'
}

// CRITICAL: Must explicitly disable conda to prevent local execution
conda {
    enabled         = false
}

singularity.enabled    = false
podman.enabled         = false

process {
    containerOptions = '--platform=linux/amd64'
    
    withLabel:process_low {
        cpus   = { check_max( 2     * task.attempt, 'cpus'    ) }
        memory = { check_max( 6.GB  * task.attempt, 'memory'  ) }
        time   = { check_max( 6.h   * task.attempt, 'time'    ) }
    }
    
    withLabel:process_medium {
        cpus   = { check_max( 2     * task.attempt, 'cpus'    ) }
        memory = { check_max( 8.GB  * task.attempt, 'memory'  ) }
        time   = { check_max( 12.h  * task.attempt, 'time'    ) }
    }
    
    withLabel:process_high {
        cpus   = { check_max( 4     * task.attempt, 'cpus'    ) }
        memory = { check_max( 10.GB * task.attempt, 'memory'  ) }
        time   = { check_max( 24.h  * task.attempt, 'time'    ) }
    }
    
    withLabel:process_high_memory {
        cpus   = { check_max( 2     * task.attempt, 'cpus'    ) }
        memory = { check_max( 10.GB * task.attempt, 'memory' ) }
        time   = { check_max( 24.h  * task.attempt, 'time'    ) }
    }
    
    // PSOCK clusters create separate R processes, each needing full data copies
    // For large datasets on memory-constrained systems, sequential is more reliable
    withName:QC_MAIN_ANALYSIS {
        cpus   = 2 
        memory = 14.GB   
        time   = 12.h
    }
}
