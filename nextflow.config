params {
  // Project Information
  project_ID = null
  responsible_person = null
  
  // Input/Output options
  input = null
  outdir = './results'
  email = null
  
  // Pipeline metadata
  app_name = 'KaryoExplorer'
  pipeline_version = '1.0'
  email_helmholtz = 'cf-bios@helmholtz-munich.de'
  support_helmholtz = 'cf-bios@helmholtz-munich.de'
  email_analyst = ''
  name_analyst = ''
  
  // Enable schema validation
  validate_params = true
  help = false
  show_version = false
  publish_dir_mode = 'copy'
  
  // Resource limits
  max_cpus = 16
  max_memory = '128.GB'
  max_time = '240.h'
  
  // Pipeline-specific parameters
  samples_refs = null
  manifest = null
  gsplink = null
  PAR = null
  fullTable = null
  samplesTable = null
  snpTable = null
  fasta = null
  workdir = null
  nhead = 7
  // CNV Analysis
  excluded_chr = "0,25,26"
  cnv_p_threshold = 0.9
  baf_threshold = 0.2
  lrr_min = -0.4
  lrr_max = 0.3
  lohc_threshold = 0.3
  min_sites = 10
  weight_lrr = 0.2
  
  // File Patterns
  summary_pattern = "summary.%s.tab"
  dat_pattern = "dat.%s.tab"
  cn_pattern = "cn.%s.tab"

  // Parameters from R scripts
  qs_thr = 2
  nSites_thr = 10
  nHet_thr = 10
  CN_len_thr = 200
  CN_len_thr_big = 1000
  width_plot = 10
  clust_sep_as = 0.3
  ABR_mean_as = 0.2
  AAR_mean_as = 0.2
  BBR_mean_as = 0.2
  ABT_mean_low_as = 0.1
  ABT_mean_up_as = 0.9
  het_low_as = -0.9
  het_up_as = 0.9
  MAF_as = 0
  hetexcess_quality_threshold = 20.0
  AAT_mean_as = 0.3
  AAT_dev_as = 0.06
  BBT_mean_as = 0.7
  BBT_dev_as = 0.06
  male_frac = 0.5
  R_hpY = 0.2
  female_frac = 0.5
  thr_par = 0.98
}

// Include base configuration
includeConfig 'conf/base.config'

// Enable plugins
plugins {
  id 'nf-validation'
}

// Function to check resource limits
def check_max(obj, type) {
    if (type == 'memory') {
        try {
            if (obj.compareTo(params.max_memory as nextflow.util.MemoryUnit) == 1)
                return params.max_memory as nextflow.util.MemoryUnit
            else
                return obj
        } catch (all) {
            println "   ### ERROR ###   Max memory '${params.max_memory}' is not valid! Using default value: $obj"
            return obj
        }
    } else if (type == 'time') {
        try {
            if (obj.compareTo(params.max_time as nextflow.util.Duration) == 1)
                return params.max_time as nextflow.util.Duration
            else
                return obj
        } catch (all) {
            println "   ### ERROR ###   Max time '${params.max_time}' is not valid! Using default value: $obj"
            return obj
        }
    } else if (type == 'cpus') {
        try {
            return Math.min( obj, params.max_cpus as int )
        } catch (all) {
            println "   ### ERROR ###   Max cpus '${params.max_cpus}' is not valid! Using default value: $obj"
            return obj
        }
    }
}

// define config profiles here
profiles {
    
    // Standard profiles
    docker {
        includeConfig 'conf/docker.config'
    }
    
    slurm {
        includeConfig 'conf/slurm.config'
    }
    
    conda {
        conda.enabled          = true
        conda.useMamba         = false
        conda.createTimeout    = '1 h'
        docker.enabled         = false
        singularity.enabled    = false
        podman.enabled         = false
        shifter.enabled        = false
        charliecloud.enabled   = false
        apptainer.enabled      = false
    }


  // Include config breaks the withLabel see https://github.com/nextflow-io/nextflow/issues/728, define here
	bcf {

		conda.enabled          = true
		conda.useMamba         = false
		conda.createTimeout    = '1 h'
		docker.enabled         = false
		singularity.enabled    = false
		podman.enabled         = false
		shifter.enabled        = false
		charliecloud.enabled   = false
		apptainer.enabled      = false

		process {

      cpus = 1
      memory = 4.GB
      time = 6.h

      errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
      maxRetries = 3
      maxErrors = '-1'

      // Executor
      executor = 'slurm'
      queue = 'bcf_p'
      clusterOptions = '--qos=bcf --nice=10000'
      
      withLabel:process_low {
        cpus = 2
        memory = { 12.GB * task.attempt }
        time = { 4.h * task.attempt }
      }
      withLabel:process_medium {
        cpus = 6
        memory = { 36.GB * task.attempt }
        time = { 8.h * task.attempt }
      }
      withLabel:process_high {
        cpus = 12
        memory = { 72.GB * task.attempt }
        time = { 16.h * task.attempt }
      }
      withLabel:process_high_memory {
        memory = { 200.GB * task.attempt }
        time = { 24.h * task.attempt }
      }
      
      // Optimized for HPC: QC process uses multiple cores for parallel processing
      withName:QC_MAIN_ANALYSIS {
        cpus = 12
        memory = { 48.GB * task.attempt }
        time = { 4.h * task.attempt }
      }

      }
	  }
  
	normal {

		conda.enabled          = true
		conda.useMamba         = false
		conda.createTimeout    = '1 h'
		docker.enabled         = false
		singularity.enabled    = false
		podman.enabled         = false
		shifter.enabled        = false
		charliecloud.enabled   = false
		apptainer.enabled      = false

		process {

      cpus = 1
      memory = 4.GB
      time = 6.h

      errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
      maxRetries = 3
      maxErrors = '-1'

      // Executor
      executor = 'slurm'
      queue = 'cpu_p'
      clusterOptions = '--qos=cpu_normal --nice=10000'
      
      withLabel:process_low {
        cpus = 2
        memory = { 12.GB * task.attempt }
        time = { 4.h * task.attempt }
      }
      withLabel:process_medium {
        cpus = 6
        memory = { 36.GB * task.attempt }
        time = { 8.h * task.attempt }
      }
      withLabel:process_high {
        cpus = 12
        memory = { 72.GB * task.attempt }
        time = { 16.h * task.attempt }
      }
      withLabel:process_high_memory {
        memory = { 200.GB * task.attempt }
        time = { 24.h * task.attempt }
      }
      
      // Optimized for HPC: QC process uses multiple cores for parallel processing
      withName:QC_MAIN_ANALYSIS {
        cpus = 12  
        memory = { 48.GB * task.attempt }
        time = { 4.h * task.attempt }  
      }

      }
	  }

}

// Set work directory inside pipeline directory
workDir = "${projectDir}/work"

def trace_timestamp = new java.util.Date().format( 'yyyy-MM-dd_HH-mm-ss')

// Ensure logs directory exists in pipeline repository
def logs_dir = new File("${projectDir}/logs")
if (!logs_dir.exists()) {
    logs_dir.mkdirs()
}
def nextflow_logs_dir = new File("${projectDir}/logs/nextflow")
if (!nextflow_logs_dir.exists()) {
    nextflow_logs_dir.mkdirs()
}

timeline {
  enabled = true
  overwrite = true
  file = "${projectDir}/logs/nextflow/timeline_${trace_timestamp}.html"
//  file = "${projectDir}/logs/nextflow/timeline.html"
}
report {
  enabled = true
  overwrite = true
  file = "${projectDir}/logs/nextflow/report_${trace_timestamp}.html"
//  file = "${projectDir}/logs/nextflow/report.html"
}
trace {
  enabled = true
  overwrite = true
  file = "${projectDir}/logs/nextflow/trace_${trace_timestamp}.txt"
//  file = "${projectDir}/logs/nextflow/trace.txt"
}
dag {
  enabled = true
  overwrite = true
  file = "${projectDir}/logs/nextflow/dag_${trace_timestamp}.svg"
//  file = "${projectDir}/logs/nextflow/dag.svg"
}
